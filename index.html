<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KO'K Doces • Calculadora & Gestão Financeira</title>
  <style>
    :root{
      --prim:#EAA6A1;    /* Rosa KO'K */
      --sec:#9DB8A4;      /* Verde sálvia */
      --ink:#2F3632;      /* Texto principal */
      --muted:#6B756F;    /* Texto secundário */
      --bg:#FBFBF7;       /* Fundo */
      --card:#FFFFFF;     /* Cartas */
      --line:#E7E7E2;     /* Bordas */
      --danger:#D15050;
      --ok:#2E7D32;
      --warn:#D98943;
      --shadow:0 10px 24px rgba(0,0,0,.05);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--ink)}
    /* ===== LAYOUT ===== */
    .app{display:grid; grid-template-columns:280px 1fr; min-height:100vh}
    aside{background:#FFF; border-right:1px solid var(--line); padding:22px 18px; position:sticky; top:0; height:100vh}
    .brand{display:flex; align-items:center; gap:12px; margin-bottom:18px}
    .brand img{width:40px; height:40px; border-radius:12px; object-fit:contain}
    .brand h1{font-size:16px; margin:0; letter-spacing:.3px}
    .stepper{display:flex; flex-direction:column; gap:8px}
    .navbtn{display:flex; gap:12px; align-items:center; padding:12px; border-radius:14px; cursor:pointer; border:1px solid var(--line); background:#fff; font-weight:600; color:#39413D}
    .navbtn:hover{border-color:var(--sec)}
    .navbtn.active{background:var(--prim); color:#fff; border-color:transparent}
    .badge{margin-left:auto; font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.6)}
    main{padding:26px 28px}
    header.top{display:flex; align-items:center; justify-content:space-between; margin-bottom:14px}
    .title{font-size:22px; font-weight:800}
    .subtitle{color:var(--muted)}

    .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:16px}
    .col-12{grid-column:span 12}
    .col-8{grid-column:span 8}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    @media (max-width:1000px){.app{grid-template-columns:1fr}.col-8,.col-6,.col-4,.col-3{grid-column:span 12} aside{position:static;height:auto}}

    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
    .card h3{margin:0 0 10px; font-size:16px}

    /* ===== FORM ===== */
    label{display:block; font-size:12px; color:var(--muted); margin:6px 0}
    input,select,textarea{width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:12px; background:#fff; outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--sec); box-shadow:0 0 0 3px rgba(157,184,164,.15)}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:12px 16px; border-radius:12px; border:1px solid var(--line); background:#fff; cursor:pointer; font-weight:700}
    .btn.primary{background:var(--prim); color:#fff; border-color:transparent}
    .btn.ghost{background:#fff}
    .btn.danger{background:var(--danger); color:#fff; border-color:transparent}

    table{width:100%; border-collapse:collapse; margin-top:8px}
    th,td{padding:10px 8px; border-bottom:1px solid var(--line); text-align:left; font-size:14px}

    .kpi{display:grid; grid-template-columns:repeat(12,1fr); gap:16px}
    .kpi .tile{grid-column:span 3}
    .tile .value{font-size:24px; font-weight:800}
    .muted{color:var(--muted)}

    .empty{border:1px dashed var(--line); padding:20px; border-radius:14px; text-align:center; color:var(--muted)}

    /* ONBOARDING */
    .onb{display:grid; grid-template-columns:repeat(12,1fr); gap:16px}
    .onb .step{grid-column:span 4; background:#fff; border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:var(--shadow)}
    .step .n{width:28px;height:28px;border-radius:999px; background:var(--sec); color:#fff; display:inline-grid; place-items:center; font-weight:800; margin-bottom:8px}

    .helper{background:linear-gradient(135deg, rgba(234,166,161,.18), rgba(157,184,164,.18)); border:1px solid var(--line); border-radius:16px; padding:14px}
  </style>
</head>
<body>
  <div class="app">
    <!-- ===== SIDEBAR ===== -->
    <aside>
      <div class="brand">
        <img id="logo" alt="KO'K" src="logo-kok.png"/>
        <h1>KO'K Doces</h1>
      </div>
      <div class="stepper">
        <div class="navbtn active" data-tab="dashboard">1. Início <span class="badge">Guia</span></div>
        <div class="navbtn" data-tab="insumos">2. Insumos</div>
        <div class="navbtn" data-tab="receitas">3. Receita & Custo</div>
        <div class="navbtn" data-tab="precificacao">4. Precificar</div>
        <div class="navbtn" data-tab="fluxo">5. Fluxo de Caixa</div>
        <div class="navbtn" data-tab="branding">Cores & Logo</div>
      </div>
      <div style="margin-top:18px" class="helper">
        <div style="font-weight:800; margin-bottom:6px">Dica rápida</div>
        Comece por <b>Insumos</b> ➜ adicione o que compra (ex.: chocolate, leite). Depois monte a <b>Receita</b> e finalize em <b>Precificar</b>.
      </div>
    </aside>

    <!-- ===== MAIN ===== -->
    <main>
      <header class="top">
        <div>
          <div class="title">Calculadora & Gestão Financeira</div>
          <div class="subtitle">Projetada para iniciantes: passo a passo, linguagem simples e exemplos.</div>
        </div>
        <div class="row">
          <button class="btn ghost" id="btnExportar">Exportar .json</button>
          <label class="btn ghost" for="importFile">Importar .json</label>
          <input id="importFile" type="file" accept="application/json" hidden>
        </div>
      </header>

      <!-- DASHBOARD -->
      <section id="dashboard" class="view">
        <div class="onb">
          <div class="step"><div class="n">1</div><h3>Cadastre Insumos</h3><div class="muted">Ex.: chocolate (1000 g por R$ 29,90) — o sistema calcula <b>custo por grama</b>.</div></div>
          <div class="step"><div class="n">2</div><h3>Monte a Receita</h3><div class="muted">Adicione os insumos usados, informe o <b>rendimento</b> e o <b>tempo</b> para calcular mão de obra.</div></div>
          <div class="step"><div class="n">3</div><h3>Defina o Preço</h3><div class="muted">Inclua embalagem, taxas e margem. Veja o <b>preço sugerido</b> e o lucro por unidade.</div></div>
        </div>

        <div class="grid" style="margin-top:16px">
          <div class="col-12 card">
            <h3>Resumo do Mês</h3>
            <div class="kpi">
              <div class="tile card"><div class="muted">Entradas</div><div class="value" id="k_entradas">R$ 0,00</div></div>
              <div class="tile card"><div class="muted">Saídas</div><div class="value" id="k_saidas">R$ 0,00</div></div>
              <div class="tile card"><div class="muted">Saldo</div><div class="value" id="k_saldo">R$ 0,00</div></div>
              <div class="tile card"><div class="muted">Receitas Cadastradas</div><div class="value" id="k_receitas">0</div></div>
            </div>
          </div>
        </div>
      </section>

      <!-- INSUMOS -->
      <section id="insumos" class="view" style="display:none">
        <div class="grid">
          <div class="col-12 card">
            <h3>Adicionar Insumo</h3>
            <div class="row">
              <div style="flex:1; min-width:200px"><label>Nome do insumo</label><input id="i_nome" placeholder="Ex.: Chocolate 70%"/></div>
              <div style="width:160px"><label>Unidade</label><select id="i_unidade"><option value="g">grama (g)</option><option value="ml">mililitro (ml)</option><option value="un">unidade (un)</option></select></div>
              <div style="width:200px"><label>Quantidade no pacote</label><input id="i_qtde" type="number" step="0.01" placeholder="Ex.: 1000"/></div>
              <div style="width:200px"><label>Preço do pacote (R$)</label><input id="i_preco" type="number" step="0.01" placeholder="Ex.: 29,90"/></div>
              <div><label>&nbsp;</label><button class="btn primary" id="btnAddInsumo">Adicionar</button></div>
            </div>
            <div class="muted" style="margin-top:6px">O custo unitário (por g/ml/un) será calculado automaticamente.</div>
          </div>

          <div class="col-12 card">
            <h3>Insumos cadastrados</h3>
            <div id="emptyInsumos" class="empty">Nenhum insumo ainda. Adicione acima.</div>
            <table id="tableInsumos" style="display:none">
              <thead><tr><th>Insumo</th><th>Un</th><th>Qtde Pacote</th><th>Preço Pacote</th><th>Custo Unit.</th><th></th></tr></thead>
              <tbody id="t_insumos"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- RECEITAS -->
      <section id="receitas" class="view" style="display:none">
        <div class="grid">
          <div class="col-12 card">
            <h3>Nova Receita</h3>
            <div class="row">
              <div style="flex:1; min-width:240px"><label>Nome da receita</label><input id="r_nome" placeholder="Ex.: Brigadeiro tradicional"/></div>
              <div style="width:220px"><label>Rendimento (unidades)</label><input id="r_rendimento" type="number" step="1" placeholder="Ex.: 25"/></div>
              <div style="width:220px"><label>Tempo de produção (minutos)</label><input id="r_tempo" type="number" step="1" placeholder="Ex.: 60"/></div>
            </div>

            <div class="row" style="margin-top:10px">
              <div style="flex:1; min-width:260px"><label>Insumo</label><select id="r_insumo"></select></div>
              <div style="width:240px"><label>Quantidade usada (mesma unidade do insumo)</label><input id="r_qtde" type="number" step="0.01"/></div>
              <div><label>&nbsp;</label><button class="btn" id="btnAddIngrediente">Adicionar ingrediente</button></div>
            </div>

            <table>
              <thead><tr><th>Insumo</th><th>Qtde</th><th>Un</th><th>Custo</th><th></th></tr></thead>
              <tbody id="t_ingredientes"></tbody>
            </table>

            <div class="row" style="margin-top:8px">
              <div class="card" style="flex:1;min-width:260px"><div class="muted">Custo total da receita</div><div id="custo_receita" class="value">R$ 0,00</div><div class="muted" id="custo_unit">Custo por unidade: R$ 0,00</div></div>
              <div class="card" style="flex:1;min-width:260px"><div class="muted">Mão de obra (opcional)</div><div class="row"><input id="r_mao_obra_hora" type="number" step="0.01" placeholder="Valor hora (R$)" style="flex:1"><button class="btn" id="btnCalcMaoObra">Ratear pelo tempo</button></div><div class="value" id="mao_obra_val">R$ 0,00</div></div>
            </div>

            <div class="row" style="margin-top:10px"><button class="btn primary" id="btnSalvarReceita">Salvar Receita</button></div>
          </div>

          <div class="col-12 card">
            <h3>Receitas salvas</h3>
            <div id="emptyReceitas" class="empty">Nenhuma receita salva ainda.</div>
            <table id="tableReceitas" style="display:none"><thead><tr><th>Receita</th><th>Rend.</th><th>Custo Total</th><th>Custo/Un</th><th></th></tr></thead><tbody id="t_receitas"></tbody></table>
          </div>
        </div>
      </section>

      <!-- PRECIFICAÇÃO -->
      <section id="precificacao" class="view" style="display:none">
        <div class="grid">
          <div class="col-12 card">
            <h3>Calcular Preço</h3>
            <div class="row">
              <div style="flex:1; min-width:260px"><label>Receita</label><select id="p_receita"></select></div>
              <div style="width:220px"><label>Preço alvo (R$) <span class="muted">(opcional)</span></label><input id="p_precoAlvo" type="number" step="0.01" placeholder="Ex.: 6,50"/></div>
              <div><label>&nbsp;</label><button class="btn" id="btnUsarCusto">Usar custo/un da receita</button></div>
            </div>

            <div class="row" style="margin-top:6px">
              <div style="width:220px"><label>Custos fixos por un. (R$)</label><input id="p_fixos" type="number" step="0.01" value="0"></div>
              <div style="width:220px"><label>Embalagem por un. (R$)</label><input id="p_embalagem" type="number" step="0.01" value="0"></div>
              <div style="width:200px"><label>Taxas de venda (%)</label><input id="p_taxas" type="number" step="0.01" value="0"></div>
              <div style="width:200px"><label>Impostos (%)</label><input id="p_impostos" type="number" step="0.01" value="0"></div>
              <div style="width:200px"><label>Comissão (%)</label><input id="p_comissao" type="number" step="0.01" value="0"></div>
              <div style="width:200px"><label>Margem desejada (%)</label><input id="p_margem" type="number" step="0.01" value="50"></div>
              <div style="width:220px"><label>Custo variável por un. (R$)</label><input id="p_cvar" type="number" step="0.0001" value="0"></div>
              <div><label>&nbsp;</label><button class="btn primary" id="btnCalcularPreco">Calcular</button></div>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="card" style="flex:1;min-width:260px"><div class="muted">Preço sugerido</div><div class="value" id="p_sugerido">R$ 0,00</div><div class="muted" id="p_resumo"></div></div>
              <div class="card" style="flex:1;min-width:260px"><div class="muted">Se usar o preço alvo</div><div class="value" id="p_margemObtida">Margem: 0%</div><div class="muted" id="p_lucroObtido"></div></div>
            </div>
            <div class="muted" style="margin-top:6px">Fórmula: <b>Preço = Custo Total / (1 - %margem - %taxas - %impostos - %comissão)</b>. Custos fixos, embalagem e custo variável entram antes do markup.</div>
          </div>
        </div>
      </section>

      <!-- FLUXO -->
      <section id="fluxo" class="view" style="display:none">
        <div class="grid">
          <div class="col-12 card">
            <h3>Lançar entrada/saída</h3>
            <div class="row">
              <div style="width:180px"><label>Data</label><input id="f_data" type="date"></div>
              <div style="width:180px"><label>Tipo</label><select id="f_tipo"><option value="entrada">Entrada</option><option value="saida">Saída</option></select></div>
              <div style="flex:1; min-width:220px"><label>Categoria</label><input id="f_cat" placeholder="Ex.: Vendas, Insumos, Embalagem"></div>
              <div style="width:220px"><label>Valor (R$)</label><input id="f_valor" type="number" step="0.01"></div>
            </div>
            <div class="row" style="margin-top:6px">
              <div style="flex:1"><label>Descrição</label><input id="f_desc" placeholder="Ex.: Venda de 20 brigadeiros"></div>
              <button class="btn primary" id="btnAddLanc">Adicionar</button>
            </div>
          </div>

          <div class="col-12 card">
            <h3>Movimentos</h3>
            <div id="emptyFluxo" class="empty">Nenhum lançamento ainda.</div>
            <table id="tableFluxo" style="display:none"><thead><tr><th>Data</th><th>Tipo</th><th>Categoria</th><th>Descrição</th><th>Valor</th><th></th></tr></thead><tbody id="t_fluxo"></tbody></table>
          </div>
        </div>
      </section>

      <!-- BRANDING -->
      <section id="branding" class="view" style="display:none">
        <div class="grid">
          <div class="col-12 card">
            <h3>Cores & Logo</h3>
            <div class="row">
              <div><label>Cor Primária</label><input type="color" id="c_primaria" value="#EAA6A1"/></div>
              <div><label>Cor Secundária</label><input type="color" id="c_secundaria" value="#9DB8A4"/></div>
              <div><label>Fundo</label><input type="color" id="c_fundo" value="#FBFBF7"/></div>
              <div><label>Logo (alterar)</label><input type="file" id="logoInput" accept="image/*"/></div>
            </div>
            <div class="muted" style="margin-top:6px">Tudo é salvo no seu navegador (localStorage).</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ===== Persistência simples =====
    const DB={get:(k,d)=>JSON.parse(localStorage.getItem(k)||JSON.stringify(d)), set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};
    const fmt=v=>(isFinite(v)?v:0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

    // Navegação
    const views=[...document.querySelectorAll('.navbtn')];
    views.forEach(btn=>btn.addEventListener('click',()=>{
      views.forEach(b=>b.classList.remove('active')); btn.classList.add('active');
      const id=btn.dataset.tab; document.querySelectorAll('.view').forEach(v=>v.style.display='none');
      document.getElementById(id).style.display='block';
      if(id==='dashboard') renderDashboard();
    }));

    // Estado
    let insumos=DB.get('insumos',[]), receitas=DB.get('receitas',[]), fluxo=DB.get('fluxo',[]), tema=DB.get('tema',{prim:'#EAA6A1',sec:'#9DB8A4',bg:'#FBFBF7',logo:null});

    // Tema
    function applyTheme(){ document.documentElement.style.setProperty('--prim', tema.prim); document.documentElement.style.setProperty('--sec', tema.sec); document.documentElement.style.setProperty('--bg', tema.bg); if(tema.logo) document.getElementById('logo').src=tema.logo; }
    document.getElementById('c_primaria').oninput=e=>{tema.prim=e.target.value; DB.set('tema',tema); applyTheme();}
    document.getElementById('c_secundaria').oninput=e=>{tema.sec=e.target.value; DB.set('tema',tema); applyTheme();}
    document.getElementById('c_fundo').oninput=e=>{tema.bg=e.target.value; DB.set('tema',tema); applyTheme();}
    document.getElementById('logoInput').addEventListener('change',e=>{const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{tema.logo=r.result; DB.set('tema',tema); applyTheme();}; r.readAsDataURL(f);});

    // INSUMOS
    const tInsumos=document.getElementById('t_insumos'), emptyInsumos=document.getElementById('emptyInsumos'), tableInsumos=document.getElementById('tableInsumos');
    document.getElementById('btnAddInsumo').onclick=()=>{
      const nome=document.getElementById('i_nome').value.trim(); const un=document.getElementById('i_unidade').value; const qtde=parseFloat(document.getElementById('i_qtde').value); const preco=parseFloat(document.getElementById('i_preco').value);
      if(!nome||!qtde||!preco) return alert('Preencha nome, quantidade e preço.');
      const custo=preco/qtde; insumos.push({id:crypto.randomUUID(),nome,un,qtde,preco,custo}); DB.set('insumos',insumos); renderInsumos(); fillInsumosSelect();
      document.getElementById('i_nome').value=''; document.getElementById('i_qtde').value=''; document.getElementById('i_preco').value='';
    };
    function delInsumo(id){insumos=insumos.filter(i=>i.id!==id); DB.set('insumos',insumos); renderInsumos(); fillInsumosSelect();}
    function renderInsumos(){ tInsumos.innerHTML=''; if(!insumos.length){emptyInsumos.style.display='block'; tableInsumos.style.display='none'; return;} emptyInsumos.style.display='none'; tableInsumos.style.display='table';
      insumos.forEach(i=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i.nome}</td><td>${i.un}</td><td>${i.qtde}</td><td>${fmt(i.preco)}</td><td>${fmt(i.custo)}</td><td><button class='btn danger' onclick="delInsumo('${i.id}')">Excluir</button></td>`; tInsumos.appendChild(tr);}); }

    // RECEITAS
    let ingTemp=[]; const tIng=document.getElementById('t_ingredientes');
    function fillInsumosSelect(){ const sel=document.getElementById('r_insumo'); sel.innerHTML=''; insumos.forEach(i=>{const o=document.createElement('option'); o.value=i.id; o.textContent=`${i.nome} (${i.un}) – ${fmt(i.custo)}/un`; sel.appendChild(o)}) }
    document.getElementById('btnAddIngrediente').onclick=()=>{ if(!insumos.length) return alert('Cadastre insumos primeiro.'); const id=document.getElementById('r_insumo').value; const ins=insumos.find(i=>i.id===id); const q=parseFloat(document.getElementById('r_qtde').value); if(!q) return alert('Informe a quantidade.'); const c=ins.custo*q; ingTemp.push({id:crypto.randomUUID(),insumoId:id,nome:ins.nome,un:ins.un,qtde:q,custo:c}); document.getElementById('r_qtde').value=''; renderIngredientes(); };
    function delIng(id){ingTemp=ingTemp.filter(i=>i.id!==id); renderIngredientes();}
    function totIng(){return ingTemp.reduce((s,i)=>s+i.custo,0)}
    function renderIngredientes(){ tIng.innerHTML=''; ingTemp.forEach(i=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i.nome}</td><td>${i.qtde}</td><td>${i.un}</td><td>${fmt(i.custo)}</td><td><button class='btn danger' onclick="delIng('${i.id}')">Excluir</button></td>`; tIng.appendChild(tr);}); const total=totIng()+ (parseFloat(document.getElementById('mao_obra_val').dataset.v)||0); document.getElementById('custo_receita').textContent=fmt(total); const rend=parseFloat(document.getElementById('r_rendimento').value)||0; document.getElementById('custo_unit').textContent=`Custo por unidade: ${fmt(rend? total/rend:0)}`; }
    document.getElementById('btnCalcMaoObra').onclick=()=>{ const h=parseFloat(document.getElementById('r_mao_obra_hora').value)||0; const min=parseFloat(document.getElementById('r_tempo').value)||0; const v=(h/60)*min; const el=document.getElementById('mao_obra_val'); el.textContent=fmt(v); el.dataset.v=v; renderIngredientes(); };
    const tReceitas=document.getElementById('t_receitas'), emptyReceitas=document.getElementById('emptyReceitas'), tableReceitas=document.getElementById('tableReceitas');
    document.getElementById('btnSalvarReceita').onclick=()=>{ const nome=document.getElementById('r_nome').value.trim(); const rend=parseFloat(document.getElementById('r_rendimento').value)||0; if(!nome||!rend||!ingTemp.length) return alert('Informe nome, rendimento e ao menos 1 ingrediente.'); const mao=parseFloat(document.getElementById('mao_obra_val').dataset.v)||0; const custo=totIng()+mao; const rec={id:crypto.randomUUID(),nome,rend,custo,custoUn:custo/rend,tempo:parseFloat(document.getElementById('r_tempo').value)||0, ingredientes:[...ingTemp]}; receitas.push(rec); DB.set('receitas',receitas); ingTemp=[]; tIng.innerHTML=''; document.getElementById('r_nome').value=''; document.getElementById('r_rendimento').value=''; document.getElementById('r_tempo').value=''; document.getElementById('mao_obra_val').textContent='R$ 0,00'; document.getElementById('mao_obra_val').dataset.v=0; document.getElementById('custo_receita').textContent='R$ 0,00'; document.getElementById('custo_unit').textContent='Custo por unidade: R$ 0,00'; renderReceitas(); fillReceitasSelect(); alert('Receita salva.'); };
    function delReceita(id){receitas=receitas.filter(r=>r.id!==id); DB.set('receitas',receitas); renderReceitas(); fillReceitasSelect();}
    function renderReceitas(){ tReceitas.innerHTML=''; if(!receitas.length){emptyReceitas.style.display='block'; tableReceitas.style.display='none'; return;} emptyReceitas.style.display='none'; tableReceitas.style.display='table'; receitas.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.nome}</td><td>${r.rend}</td><td>${fmt(r.custo)}</td><td>${fmt(r.custoUn)}</td><td><button class='btn danger' onclick="delReceita('${r.id}')">Excluir</button></td>`; tReceitas.appendChild(tr);}); }
    function fillReceitasSelect(){ const sel=document.getElementById('p_receita'); sel.innerHTML=''; receitas.forEach(r=>{ const o=document.createElement('option'); o.value=r.id; o.textContent=`${r.nome} – custo/un ${fmt(r.custoUn)}`; sel.appendChild(o) }) }

    // PRECIFICAÇÃO
    document.getElementById('btnUsarCusto').onclick=()=>{ const id=document.getElementById('p_receita').value; const r=receitas.find(x=>x.id===id); if(!r) return alert('Selecione uma receita.'); document.getElementById('p_cvar').value=(r.custoUn).toFixed(4); };
    document.getElementById('btnCalcularPreco').onclick=()=>{ const id=document.getElementById('p_receita').value; const r=receitas.find(x=>x.id===id); if(!r) return alert('Selecione uma receita.'); const alvo=parseFloat(document.getElementById('p_precoAlvo').value)||0; const fix=parseFloat(document.getElementById('p_fixos').value)||0; const emb=parseFloat(document.getElementById('p_embalagem').value)||0; const taxas=(parseFloat(document.getElementById('p_taxas').value)||0)/100; const imp=(parseFloat(document.getElementById('p_impostos').value)||0)/100; const com=(parseFloat(document.getElementById('p_comissao').value)||0)/100; const marg=(parseFloat(document.getElementById('p_margem').value)||0)/100; const cvar=parseFloat(document.getElementById('p_cvar').value)||0; const custo=cvar+fix+emb; const divisor=1-(marg+taxas+imp+com); if(divisor<=0) return alert('Margem+taxas+impostos+comissão não podem somar 100% ou mais.'); const preco=custo/divisor; document.getElementById('p_sugerido').textContent=fmt(preco); document.getElementById('p_resumo').textContent=`Custo base ${fmt(cvar)} + fixos ${fmt(fix)} + emb ${fmt(emb)} | markup ${(1/divisor).toFixed(2)}x`; if(alvo>0){ const perc=(taxas+imp+com); const receitaLiquida=alvo*(1-perc); const lucro=receitaLiquida-(cvar+fix+emb); const margemObtida=lucro/alvo; document.getElementById('p_margemObtida').textContent=`Margem: ${(margemObtida*100).toFixed(1)}%`; document.getElementById('p_lucroObtido').textContent=`Lucro líquido por un.: ${fmt(lucro)}`; } };

    // FLUXO
    const tFluxo=document.getElementById('t_fluxo'), emptyFluxo=document.getElementById('emptyFluxo'), tableFluxo=document.getElementById('tableFluxo');
    document.getElementById('btnAddLanc').onclick=()=>{ const data=document.getElementById('f_data').value || new Date().toISOString().slice(0,10); const tipo=document.getElementById('f_tipo').value; const cat=document.getElementById('f_cat').value||'-'; const val=parseFloat(document.getElementById('f_valor').value); if(!val) return alert('Informe o valor.'); const desc=document.getElementById('f_desc').value||''; const item={id:crypto.randomUUID(), data, tipo, cat, val: tipo==='saida'? -Math.abs(val): Math.abs(val), desc}; fluxo.push(item); DB.set('fluxo',fluxo); renderFluxo(); renderDashboard(); document.getElementById('f_valor').value=''; document.getElementById('f_desc').value=''; };
    function delLanc(id){ fluxo=fluxo.filter(x=>x.id!==id); DB.set('fluxo',fluxo); renderFluxo(); renderDashboard(); }
    function renderFluxo(){ tFluxo.innerHTML=''; if(!fluxo.length){emptyFluxo.style.display='block'; tableFluxo.style.display='none'; return;} emptyFluxo.style.display='none'; tableFluxo.style.display='table'; fluxo.sort((a,b)=>a.data.localeCompare(b.data)); fluxo.forEach(l=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${l.data}</td><td>${l.tipo}</td><td>${l.cat}</td><td>${l.desc||''}</td><td style="color:${l.val<0?'#D15050':'#2E7D32'}">${fmt(l.val)}</td><td><button class='btn danger' onclick="delLanc('${l.id}')">Excluir</button></td>`; tFluxo.appendChild(tr); }); }

    // Exportar/Importar
    document.getElementById('btnExportar').onclick=()=>{ const data={insumos,receitas,fluxo,tema}; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='kok-financas.json'; a.click(); URL.revokeObjectURL(url); };
    document.getElementById('importFile').addEventListener('change',(e)=>{ const file=e.target.files[0]; if(!file) return; const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result); if(data.insumos) insumos=data.insumos; if(data.receitas) receitas=data.receitas; if(data.fluxo) fluxo=data.fluxo; if(data.tema) tema=data.tema; DB.set('insumos',insumos); DB.set('receitas',receitas); DB.set('fluxo',fluxo); DB.set('tema',tema); applyTheme(); renderInsumos(); fillInsumosSelect(); renderReceitas(); fillReceitasSelect(); renderFluxo(); renderDashboard(); alert('Dados importados com sucesso.'); }catch(err){ alert('Arquivo inválido.'); } }; r.readAsText(file); });

    // Dashboard
    function sumMonth(){ const now=new Date(); const m=now.getMonth()+1, y=now.getFullYear(); const items=fluxo.filter(x=>{const [Y,M]=x.data.split('-'); return +Y===y && +M===m}); const entradas=items.filter(x=>x.val>0).reduce((s,x)=>s+x.val,0); const saidas=items.filter(x=>x.val<0).reduce((s,x)=>s+x.val,0); return {entradas, saidas:Math.abs(saidas), saldo:entradas+saidas} }
    function renderDashboard(){ const m=sumMonth(); document.getElementById('k_entradas').textContent=fmt(m.entradas); document.getElementById('k_saidas').textContent=fmt(m.saidas); document.getElementById('k_saldo').textContent=fmt(m.saldo); document.getElementById('k_receitas').textContent=receitas.length; }

    // Init
    function init(){ applyTheme(); renderInsumos(); fillInsumosSelect(); renderReceitas(); fillReceitasSelect(); renderFluxo(); renderDashboard(); }
    init();
  </script>
</body>
</html>

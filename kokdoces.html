<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KO'K Doces • Gestão Financeira & Precificação</title>
  <style>
    :root{
      /* === PALETA: ajuste conforme sua marca === */
      --cor-primaria:#EAA6A1;  /* rosa pastel do logo (aprox) */
      --cor-secundaria:#9DB8A4;/* verde sálvia (aprox) */
      --cor-escura:#3E3E3E;
      --cor-clara:#FBFBF7;
      --cor-borda:#E6E6E0;
      --ok:#3BAA5D;
      --alerta:#D98B2B;
      --erro:#C85252;
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;
      color:var(--cor-escura); background:var(--cor-clara);
    }
    header{
      position:sticky; top:0; z-index:5; backdrop-filter:saturate(180%) blur(6px);
      background:rgba(251,251,247,.85); border-bottom:1px solid var(--cor-borda);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:16px}
    .brand{display:flex; align-items:center; gap:14px}
    .brand img{width:42px; height:42px; object-fit:contain; border-radius:8px}
    .brand h1{font-size:18px; margin:0; letter-spacing:.2px}
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .tab-btn{
      border:1px solid var(--cor-borda); background:#fff; padding:8px 12px; border-radius:10px;
      cursor:pointer; font-weight:600; transition:.2s; color:#38423B
    }
    .tab-btn.active{background:var(--cor-primaria); color:#fff; border-color:transparent}

    main{max-width:1100px; margin:18px auto; padding:0 16px 40px}
    section{display:none; background:white; border:1px solid var(--cor-borda); border-radius:16px; padding:18px; margin-bottom:18px}
    section.active{display:block}
    h2{margin:4px 0 12px 0; font-size:18px}
    h3{margin:14px 0 8px; font-size:15px}

    .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:12px}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    .col-12{grid-column:span 12}
    @media (max-width:900px){.col-6,.col-4,.col-3{grid-column:span 12}}

    label{font-size:12px; color:#53605A}
    input,select,textarea{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--cor-borda); background:#fff; outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:var(--cor-secundaria)}
    .btn{display:inline-flex; align-items:center; gap:8px; border:none; cursor:pointer; padding:10px 14px; border-radius:12px; font-weight:700}
    .btn-primary{background:var(--cor-primaria); color:#fff}
    .btn-ghost{background:#fff; border:1px solid var(--cor-borda)}
    .btn-danger{background:var(--erro); color:#fff}

    .kpi{
      display:grid; grid-template-columns:repeat(12,1fr); gap:12px; margin:12px 0 6px
    }
    .card{grid-column:span 3; background:white; border:1px solid var(--cor-borda); border-radius:14px; padding:14px}
    .card .value{font-size:22px; font-weight:800}
    .card small{color:#6A756F}
    @media (max-width:900px){.card{grid-column:span 12}}

    table{width:100%; border-collapse:collapse; margin-top:10px}
    th,td{padding:10px 8px; border-bottom:1px solid var(--cor-borda); text-align:left; font-size:14px}

    .pill{display:inline-flex; gap:6px; align-items:center; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--cor-borda)}
    .muted{color:#66726C}
    .hint{font-size:12px; color:#6A6A6A}
    .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    .footer{font-size:12px; color:#6C6C6C; text-align:center; padding:16px}

    .color-row{display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap}
    .swatch{width:40px; height:40px; border-radius:10px; border:1px solid var(--cor-borda)}

    .chip{background:var(--cor-secundaria); color:white; font-weight:700; padding:4px 10px; border-radius:999px; display:inline-block}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <!-- Substitua o src abaixo pelo caminho do seu arquivo de logo -->
        <img id="logo" alt="LOGO" src="logo-kok.png">
        <h1>KO'K Doces • Plataforma Financeira</h1>
        <span class="chip" title="Seus dados ficam no seu navegador">Beta Local</span>
      </div>
      <div class="tabs" id="tabs"></div>
    </div>
  </header>

  <main>
    <!-- DASHBOARD -->
    <section id="dashboard" class="active">
      <h2>Visão Geral</h2>
      <div class="kpi" id="kpis"></div>
      <div class="grid">
        <div class="col-6">
          <h3>Resumo do Mês</h3>
          <table>
            <tbody id="resumoMes"></tbody>
          </table>
        </div>
        <div class="col-6">
          <h3>Ponto de Equilíbrio</h3>
          <div class="hint">Cobre custos fixos com a margem de contribuição.</div>
          <table>
            <tbody id="breakeven"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- INSUMOS -->
    <section id="insumos">
      <h2>Cadastro de Insumos</h2>
      <div class="grid">
        <div class="col-3">
          <label>Nome</label>
          <input id="i_nome" placeholder="Ex.: Chocolate 70%"/>
        </div>
        <div class="col-3">
          <label>Unidade de Medida</label>
          <select id="i_unidade">
            <option value="g">grama (g)</option>
            <option value="ml">mililitro (ml)</option>
            <option value="un">unidade (un)</option>
          </select>
        </div>
        <div class="col-3">
          <label>Quantidade no Pacote</label>
          <input id="i_qtde" type="number" step="0.01" placeholder="Ex.: 1000"/>
        </div>
        <div class="col-3">
          <label>Preço do Pacote (R$)</label>
          <input id="i_preco" type="number" step="0.01" placeholder="Ex.: 29,90"/>
        </div>
        <div class="col-12 flex">
          <button class="btn btn-primary" id="btnAddInsumo">Adicionar</button>
          <span class="hint">O sistema calcula o custo <b>por g/ml/un</b> automaticamente.</span>
        </div>
      </div>
      <table>
        <thead>
          <tr><th>Insumo</th><th>Un</th><th>Qtde Pacote</th><th>Preço Pacote</th><th>Custo Unit.</th><th></th></tr>
        </thead>
        <tbody id="t_insumos"></tbody>
      </table>
    </section>

    <!-- RECEITAS -->
    <section id="receitas">
      <h2>Receita & Custo</h2>
      <div class="grid">
        <div class="col-4">
          <label>Nome da Receita</label>
          <input id="r_nome" placeholder="Ex.: Brigadeiro Tradicional"/>
        </div>
        <div class="col-4">
          <label>Rendimento (unidades)</label>
          <input id="r_rendimento" type="number" step="1" placeholder="Ex.: 25"/>
        </div>
        <div class="col-4">
          <label>Tempo de produção (minutos)</label>
          <input id="r_tempo" type="number" step="1" placeholder="Ex.: 60"/>
        </div>
      </div>
      <h3>Ingredientes</h3>
      <div class="grid">
        <div class="col-4">
          <label>Insumo</label>
          <select id="r_insumo"></select>
        </div>
        <div class="col-4">
          <label>Quantidade usada (na mesma unidade do insumo)</label>
          <input id="r_qtde" type="number" step="0.01"/>
        </div>
        <div class="col-4" style="align-self:end">
          <button class="btn btn-primary" id="btnAddIngrediente">Adicionar Ingrediente</button>
        </div>
      </div>
      <table>
        <thead>
          <tr><th>Insumo</th><th>Qtde</th><th>Un</th><th>Custo</th><th></th></tr>
        </thead>
        <tbody id="t_ingredientes"></tbody>
      </table>
      <div class="grid">
        <div class="col-6">
          <div class="card">
            <div class="muted">Custo total da receita</div>
            <div class="value" id="custo_receita">R$ 0,00</div>
            <small id="custo_unit">Custo por unidade: R$ 0,00</small>
          </div>
        </div>
        <div class="col-6">
          <div class="card">
            <div class="muted">Custo de mão de obra (opcional)</div>
            <div class="flex">
              <input id="r_mao_obra_hora" type="number" step="0.01" placeholder="Valor hora (R$)"/>
              <button class="btn btn-ghost" id="btnCalcMaoObra">Ratear pelo tempo</button>
            </div>
            <small class="hint">Serão considerados os minutos informados da receita.</small>
            <div class="value" id="mao_obra_val">R$ 0,00</div>
          </div>
        </div>
      </div>
      <div class="flex">
        <button class="btn btn-primary" id="btnSalvarReceita">Salvar Receita</button>
        <span class="hint">As receitas ficam salvas no seu navegador (localStorage).</span>
      </div>
      <h3>Receitas Salvas</h3>
      <table>
        <thead><tr><th>Receita</th><th>Rend.</th><th>Custo Total</th><th>Custo/Un</th><th></th></tr></thead>
        <tbody id="t_receitas"></tbody>
      </table>
    </section>

    <!-- PRECIFICAÇÃO -->
    <section id="precificacao">
      <h2>Precificação</h2>
      <div class="grid">
        <div class="col-4">
          <label>Selecione a Receita</label>
          <select id="p_receita"></select>
        </div>
        <div class="col-4">
          <label>Preço alvo (R$) <span class="hint">(opcional)</span></label>
          <input id="p_precoAlvo" type="number" step="0.01" placeholder="Ex.: 6,50"/>
        </div>
        <div class="col-4" style="align-self:end">
          <button class="btn btn-ghost" id="btnUsarCusto">Usar custo/un da receita</button>
        </div>
      </div>

      <div class="grid">
        <div class="col-3"><label>Custos fixos rateio por unidade (R$)</label><input id="p_fixos" type="number" step="0.01" value="0"></div>
        <div class="col-3"><label>Embalagem por unidade (R$)</label><input id="p_embalagem" type="number" step="0.01" value="0"></div>
        <div class="col-3"><label>Taxas de venda (%)</label><input id="p_taxas" type="number" step="0.01" value="0"></div>
        <div class="col-3"><label>Impostos (%)</label><input id="p_impostos" type="number" step="0.01" value="0"></div>
        <div class="col-3"><label>Comissão (%)</label><input id="p_comissao" type="number" step="0.01" value="0"></div>
        <div class="col-3"><label>Margem desejada (%)</label><input id="p_margem" type="number" step="0.01" value="50"></div>
        <div class="col-3"><label>Custo variável por unidade (R$)</label><input id="p_cvar" type="number" step="0.0001" value="0"></div>
        <div class="col-3" style="align-self:end"><button class="btn btn-primary" id="btnCalcularPreco">Calcular</button></div>
      </div>

      <div class="grid">
        <div class="col-6">
          <div class="card">
            <div class="muted">Preço sugerido</div>
            <div class="value" id="p_sugerido">R$ 0,00</div>
            <small id="p_resumo" class="muted"></small>
          </div>
        </div>
        <div class="col-6">
          <div class="card">
            <div class="muted">Com o preço alvo</div>
            <div class="value" id="p_margemObtida">Margem: 0%</div>
            <small id="p_lucroObtido" class="muted"></small>
          </div>
        </div>
      </div>

      <div class="hint">Formula base (markup por margem): <b>Preço = Custo Total / (1 - %margem - %taxas - %impostos - %comissão)</b>. Custos fixos, embalagem e custo variável são somados ao custo/un antes do markup.</div>
    </section>

    <!-- FLUXO DE CAIXA -->
    <section id="fluxo">
      <h2>Fluxo de Caixa</h2>
      <div class="grid">
        <div class="col-3"><label>Data</label><input id="f_data" type="date"></div>
        <div class="col-3"><label>Tipo</label><select id="f_tipo"><option value="entrada">Entrada</option><option value="saida">Saída</option></select></div>
        <div class="col-3"><label>Categoria</label><input id="f_cat" placeholder="Ex.: Vendas, Insumos, Embalagem"></div>
        <div class="col-3"><label>Valor (R$)</label><input id="f_valor" type="number" step="0.01"></div>
        <div class="col-12"><label>Descrição</label><input id="f_desc" placeholder="Ex.: Venda de 20 brigadeiros"></div>
        <div class="col-12 flex"><button class="btn btn-primary" id="btnAddLanc">Adicionar Lançamento</button>
        <button class="btn btn-ghost" id="btnExportar">Exportar .json</button>
        <label class="btn btn-ghost" for="importFile">Importar .json</label><input id="importFile" type="file" accept="application/json" hidden></div>
      </div>
      <table>
        <thead><tr><th>Data</th><th>Tipo</th><th>Categoria</th><th>Descrição</th><th>Valor</th><th></th></tr></thead>
        <tbody id="t_fluxo"></tbody>
      </table>
    </section>

    <!-- CONFIGURAÇÕES DE MARCA -->
    <section id="branding">
      <h2>Identidade Visual</h2>
      <div class="color-row">
        <div>
          <label>Cor Primária</label>
          <input type="color" id="c_primaria" value="#EAA6A1"/>
        </div>
        <div>
          <label>Cor Secundária</label>
          <input type="color" id="c_secundaria" value="#9DB8A4"/>
        </div>
        <div>
          <label>Fundo</label>
          <input type="color" id="c_fundo" value="#FBFBF7"/>
        </div>
        <div>
          <label>Logo (trocar)</label>
          <input type="file" id="logoInput" accept="image/*"/>
        </div>
      </div>
      <p class="hint">As mudanças são salvas no navegador. Dica: use as cores exatas da sua paleta.</p>
    </section>

    <div class="footer">© <span id="ano"></span> KO'K Doces • Ferramenta de apoio à gestão financeira e precificação. Seus dados ficam no seu navegador.</div>
  </main>

  <script>
    /* ======= Persistência simples ======= */
    const DB = {
      get: (k, def) => JSON.parse(localStorage.getItem(k) || JSON.stringify(def)),
      set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
      del: (k) => localStorage.removeItem(k)
    };

    const fmtMoeda = v => (isFinite(v)? v:0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    const pct = v => `${(v*100).toFixed(1)}%`;

    /* ======= Navegação ======= */
    const seções = [
      {id:'dashboard', nome:'Dashboard'},
      {id:'insumos', nome:'Insumos'},
      {id:'receitas', nome:'Receitas'},
      {id:'precificacao', nome:'Precificação'},
      {id:'fluxo', nome:'Fluxo de Caixa'},
      {id:'branding', nome:'Identidade Visual'},
    ];
    const tabs = document.getElementById('tabs');
    seções.forEach((s,i)=>{
      const b=document.createElement('button'); b.className='tab-btn'+(i===0?' active':''); b.textContent=s.nome; b.onclick=()=>ativar(s.id,b); tabs.appendChild(b);
    });
    function ativar(id, btn){
      document.querySelectorAll('section').forEach(sec=>sec.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      if(id==='dashboard') renderDashboard();
    }

    /* ======= Dados ======= */
    let insumos = DB.get('insumos', []);
    let receitas = DB.get('receitas', []);
    let fluxo = DB.get('fluxo', []);
    let tema = DB.get('tema', {primaria:getComputedStyle(document.documentElement).getPropertyValue('--cor-primaria').trim(), secundária:getComputedStyle(document.documentElement).getPropertyValue('--cor-secundaria').trim(), fundo:getComputedStyle(document.documentElement).getPropertyValue('--cor-clara').trim(), logo:null});

    // ======= INSUMOS =======
    document.getElementById('btnAddInsumo').onclick = ()=>{
      const nome = document.getElementById('i_nome').value.trim();
      const unidade = document.getElementById('i_unidade').value;
      const qtde = parseFloat(document.getElementById('i_qtde').value);
      const preco = parseFloat(document.getElementById('i_preco').value);
      if(!nome||!qtde||!preco) return alert('Preencha nome, quantidade e preço.');
      const custoUnit = preco/qtde; // custo por g/ml/un
      insumos.push({id:crypto.randomUUID(), nome, unidade, qtde, preco, custoUnit});
      DB.set('insumos',insumos);
      renderInsumos();
      preencherInsumosSelect();
      document.getElementById('i_nome').value=''; document.getElementById('i_qtde').value=''; document.getElementById('i_preco').value='';
    };
    function removerInsumo(id){ insumos = insumos.filter(x=>x.id!==id); DB.set('insumos', insumos); renderInsumos(); preencherInsumosSelect(); }
    function renderInsumos(){
      const tb=document.getElementById('t_insumos'); tb.innerHTML='';
      insumos.forEach(i=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i.nome}</td><td>${i.unidade}</td><td>${i.qtde}</td><td>${fmtMoeda(i.preco)}</td><td>${fmtMoeda(i.custoUnit)}</td><td><button class='btn btn-danger' onclick="removerInsumo('${i.id}')">Excluir</button></td>`;
        tb.appendChild(tr);
      })
    }
    function preencherInsumosSelect(){
      const sel=document.getElementById('r_insumo'); sel.innerHTML='';
      insumos.forEach(i=>{ const o=document.createElement('option'); o.value=i.id; o.textContent=`${i.nome} (${i.unidade}) – ${fmtMoeda(i.custoUnit)}/un`; sel.appendChild(o) })
    }

    // ======= RECEITAS =======
    let ingredientesTemp=[]; // ingredientes da receita em edição
    document.getElementById('btnAddIngrediente').onclick=()=>{
      if(!insumos.length) return alert('Cadastre insumos primeiro.');
      const id=document.getElementById('r_insumo').value; const ins=insumos.find(x=>x.id===id);
      const qtde=parseFloat(document.getElementById('r_qtde').value); if(!qtde) return alert('Informe a quantidade.');
      const custo=ins.custoUnit*qtde;
      ingredientesTemp.push({id:crypto.randomUUID(), insumoId:id, nome:ins.nome, un:ins.unidade, qtde, custo});
      document.getElementById('r_qtde').value='';
      renderIngredientes();
    }
    function removerIngrediente(id){ ingredientesTemp=ingredientesTemp.filter(x=>x.id!==id); renderIngredientes(); }
    function totalIngredientes(){ return ingredientesTemp.reduce((s,i)=>s+i.custo,0); }
    function renderIngredientes(){
      const tb=document.getElementById('t_ingredientes'); tb.innerHTML='';
      ingredientesTemp.forEach(i=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i.nome}</td><td>${i.qtde}</td><td>${i.un}</td><td>${fmtMoeda(i.custo)}</td><td><button class='btn btn-danger' onclick="removerIngrediente('${i.id}')">Excluir</button></td>`;
        tb.appendChild(tr);
      });
      const total=totalIngredientes()+ (parseFloat(document.getElementById('mao_obra_val').dataset.v)||0);
      document.getElementById('custo_receita').textContent=fmtMoeda(total);
      const rend=parseFloat(document.getElementById('r_rendimento').value)||0; document.getElementById('custo_unit').textContent=`Custo por unidade: ${fmtMoeda(rend? total/rend : 0)}`;
    }
    document.getElementById('btnCalcMaoObra').onclick=()=>{
      const valHora=parseFloat(document.getElementById('r_mao_obra_hora').value)||0; const min=parseFloat(document.getElementById('r_tempo').value)||0;
      const rateio=(valHora/60)*min; const el=document.getElementById('mao_obra_val'); el.textContent=fmtMoeda(rateio); el.dataset.v=rateio;
      renderIngredientes();
    }

    document.getElementById('btnSalvarReceita').onclick=()=>{
      const nome=document.getElementById('r_nome').value.trim(); const rend=parseFloat(document.getElementById('r_rendimento').value)||0;
      if(!nome||!rend||!ingredientesTemp.length) return alert('Informe nome, rendimento e ao menos 1 ingrediente.');
      const maoObra=parseFloat(document.getElementById('mao_obra_val').dataset.v)||0;
      const custo=totalIngredientes()+maoObra;
      const receita={id:crypto.randomUUID(), nome, rend, custo, custoUn:custo/rend, tempo:parseFloat(document.getElementById('r_tempo').value)||0, ingredientes:[...ingredientesTemp]};
      receitas.push(receita); DB.set('receitas', receitas);
      ingredientesTemp=[]; document.getElementById('t_ingredientes').innerHTML=''; document.getElementById('r_nome').value=''; document.getElementById('r_rendimento').value=''; document.getElementById('r_tempo').value='';
      document.getElementById('mao_obra_val').textContent='R$ 0,00'; document.getElementById('mao_obra_val').dataset.v=0; document.getElementById('custo_receita').textContent='R$ 0,00'; document.getElementById('custo_unit').textContent='Custo por unidade: R$ 0,00';
      renderReceitas(); preencherReceitasSelect();
      alert('Receita salva.');
    }
    function removerReceita(id){ receitas = receitas.filter(x=>x.id!==id); DB.set('receitas', receitas); renderReceitas(); preencherReceitasSelect(); }
    function renderReceitas(){
      const tb=document.getElementById('t_receitas'); tb.innerHTML='';
      receitas.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r.nome}</td><td>${r.rend}</td><td>${fmtMoeda(r.custo)}</td><td>${fmtMoeda(r.custoUn)}</td><td><button class='btn btn-danger' onclick="removerReceita('${r.id}')">Excluir</button></td>`;
        tb.appendChild(tr);
      })
    }
    function preencherReceitasSelect(){
      const sel=document.getElementById('p_receita'); sel.innerHTML='';
      receitas.forEach(r=>{ const o=document.createElement('option'); o.value=r.id; o.textContent=`${r.nome} – custo/un ${fmtMoeda(r.custoUn)}`; sel.appendChild(o) })
    }

    // ======= PRECIFICAÇÃO =======
    document.getElementById('btnUsarCusto').onclick=()=>{
      const id=document.getElementById('p_receita').value; const r=receitas.find(x=>x.id===id); if(!r) return alert('Selecione uma receita.');
      document.getElementById('p_cvar').value=(r.custoUn).toFixed(4);
    }
    document.getElementById('btnCalcularPreco').onclick=()=>{
      const id=document.getElementById('p_receita').value; const r=receitas.find(x=>x.id===id); if(!r) return alert('Selecione uma receita.');
      const precoAlvo=parseFloat(document.getElementById('p_precoAlvo').value)||0;
      const fixos=parseFloat(document.getElementById('p_fixos').value)||0;
      const emb=parseFloat(document.getElementById('p_embalagem').value)||0;
      const taxas=(parseFloat(document.getElementById('p_taxas').value)||0)/100;
      const imp=(parseFloat(document.getElementById('p_impostos').value)||0)/100;
      const com=(parseFloat(document.getElementById('p_comissao').value)||0)/100;
      const margem=(parseFloat(document.getElementById('p_margem').value)||0)/100;
      const cvar=parseFloat(document.getElementById('p_cvar').value)||0; // custo variável base (custo/un da receita)
      const custoTotal = cvar + fixos + emb; // soma antes do markup
      const divisor = 1 - (margem + taxas + imp + com);
      if(divisor<=0){ alert('A soma de margem + taxas + impostos + comissão não pode ser >= 100%.'); return; }
      const preco = custoTotal / divisor;
      document.getElementById('p_sugerido').textContent = fmtMoeda(preco);
      document.getElementById('p_resumo').textContent = `Custo base ${fmtMoeda(cvar)} + fixos ${fmtMoeda(fixos)} + embalagem ${fmtMoeda(emb)} | markup efetivo ${(1/divisor).toFixed(2)}x`;

      if(precoAlvo>0){
        const custosPercentuais = (taxas+imp+com);
        const receitaLiquida = precoAlvo*(1 - custosPercentuais);
        const lucro = receitaLiquida - (cvar + fixos + emb);
        const margemObtida = lucro / precoAlvo;
        document.getElementById('p_margemObtida').textContent = `Margem: ${(margemObtida*100).toFixed(1)}%`;
        document.getElementById('p_lucroObtido').textContent = `Lucro líquido por unidade: ${fmtMoeda(lucro)}`;
      }
    }

    // ======= FLUXO DE CAIXA =======
    document.getElementById('btnAddLanc').onclick=()=>{
      const data=document.getElementById('f_data').value || new Date().toISOString().slice(0,10);
      const tipo=document.getElementById('f_tipo').value; const cat=document.getElementById('f_cat').value||'-';
      const val=parseFloat(document.getElementById('f_valor').value); if(!val) return alert('Informe o valor.');
      const desc=document.getElementById('f_desc').value||'';
      const item={id:crypto.randomUUID(), data, tipo, cat, val:tipo==='saida'? -Math.abs(val): Math.abs(val), desc};
      fluxo.push(item); DB.set('fluxo',fluxo); renderFluxo(); renderDashboard();
      document.getElementById('f_valor').value=''; document.getElementById('f_desc').value='';
    }
    function removerLanc(id){ fluxo=fluxo.filter(x=>x.id!==id); DB.set('fluxo',fluxo); renderFluxo(); renderDashboard(); }
    function renderFluxo(){
      const tb=document.getElementById('t_fluxo'); tb.innerHTML='';
      fluxo.sort((a,b)=>a.data.localeCompare(b.data));
      fluxo.forEach(l=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${l.data}</td><td>${l.tipo}</td><td>${l.cat}</td><td>${l.desc||''}</td><td style="color:${l.val<0?'#C85252':'#2D7A42'}">${fmtMoeda(l.val)}</td><td><button class='btn btn-danger' onclick="removerLanc('${l.id}')">Excluir</button></td>`;
        tb.appendChild(tr);
      })
    }

    // Exportar/Importar
    document.getElementById('btnExportar').onclick=()=>{
      const data={insumos, receitas, fluxo, tema};
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='kok-financas.json'; a.click(); URL.revokeObjectURL(url);
    };
    document.getElementById('importFile').addEventListener('change', (e)=>{
      const file=e.target.files[0]; if(!file) return; const r=new FileReader(); r.onload=()=>{
        try{ const data=JSON.parse(r.result);
          if(data.insumos) insumos=data.insumos; if(data.receitas) receitas=data.receitas; if(data.fluxo) fluxo=data.fluxo; if(data.tema) tema=data.tema;
          DB.set('insumos',insumos); DB.set('receitas',receitas); DB.set('fluxo',fluxo); DB.set('tema',tema);
          aplicarTema(); renderInsumos(); preencherInsumosSelect(); renderReceitas(); preencherReceitasSelect(); renderFluxo(); renderDashboard();
          alert('Dados importados com sucesso.');
        }catch(err){ alert('Arquivo inválido.'); }
      }; r.readAsText(file);
    });

    // ======= DASHBOARD =======
    function somaPeriodo(m){
      // m: número do mês atual (1-12). Se omitido, usa mês atual
      const now=new Date(); const mes = m || (now.getMonth()+1); const ano=now.getFullYear();
      const items=fluxo.filter(x=>{ const [Y,M]=x.data.split('-'); return +Y===ano && +M===mes; });
      const entradas = items.filter(x=>x.val>0).reduce((s,x)=>s+x.val,0);
      const saidas = items.filter(x=>x.val<0).reduce((s,x)=>s+x.val,0);
      const saldo = entradas + saidas; // saidas negativo
      return {entradas, saidas:Math.abs(saidas), saldo}
    }
    function renderDashboard(){
      const m = somaPeriodo();
      const kpis=document.getElementById('kpis');
      kpis.innerHTML = `
        <div class='card'><div class='muted'>Entradas (mês)</div><div class='value'>${fmtMoeda(m.entradas)}</div></div>
        <div class='card'><div class='muted'>Saídas (mês)</div><div class='value'>${fmtMoeda(m.saidas)}</div></div>
        <div class='card'><div class='muted'>Saldo (mês)</div><div class='value'>${fmtMoeda(m.saldo)}</div></div>
        <div class='card'><div class='muted'>Receitas cadastradas</div><div class='value'>${receitas.length}</div><small>Gerencie custos e preço</small></div>
      `;

      // Resumo mês
      const rm=document.getElementById('resumoMes');
      rm.innerHTML = `
        <tr><td>Total de lançamentos</td><td>${fluxo.length}</td></tr>
        <tr><td>Ticket médio entrada</td><td>${fmtMoeda(m.entradas/Math.max(1, fluxo.filter(x=>x.val>0).length))}</td></tr>
        <tr><td>Maior categoria de saída</td><td>${maiorCategoria('saida')||'-'}</td></tr>
        <tr><td>Maior categoria de entrada</td><td>${maiorCategoria('entrada')||'-'}</td></tr>
      `;

      // Breakeven simplificado (mês)
      const custosFixosMes = fluxo.filter(x=>x.val<0 && /fixo|aluguel|energia|internet|salario/i.test(x.cat||'')).reduce((s,x)=>s+Math.abs(x.val),0);
      const margemMedia = 0.5; // suposição conservadora
      const breakevenQtd = custosFixosMes / (margemMedia* (receitas[0]?.custoUn? (document.getElementById('p_precoAlvo')?.value || (receitas[0].custoUn*2)) : 10));
      const be=document.getElementById('breakeven');
      be.innerHTML = `
        <tr><td>Custos fixos estimados</td><td>${fmtMoeda(custosFixosMes)}</td></tr>
        <tr><td>Margem de contribuição suposta</td><td>${pct(margemMedia)}</td></tr>
        <tr><td>Unidades necessárias (estimado)</td><td>${isFinite(breakevenQtd)?breakevenQtd.toFixed(0):'-'}</td></tr>
      `;
    }
    function maiorCategoria(tipo){
      const map={}; fluxo.filter(x=>x.tipo===tipo).forEach(x=>{ map[x.cat]= (map[x.cat]||0) + Math.abs(x.val);});
      let top=null, val=0; Object.keys(map).forEach(k=>{ if(map[k]>val){val=map[k]; top=k}}); return top;
    }

    // ======= IDENTIDADE VISUAL =======
    function aplicarTema(){
      document.documentElement.style.setProperty('--cor-primaria', tema.primaria);
      document.documentElement.style.setProperty('--cor-secundaria', tema.secundária);
      document.documentElement.style.setProperty('--cor-clara', tema.fundo);
      if(tema.logo){ document.getElementById('logo').src = tema.logo; }
    }
    document.getElementById('c_primaria').addEventListener('input', e=>{ tema.primaria=e.target.value; DB.set('tema',tema); aplicarTema(); });
    document.getElementById('c_secundaria').addEventListener('input', e=>{ tema.secundária=e.target.value; DB.set('tema',tema); aplicarTema(); });
    document.getElementById('c_fundo').addEventListener('input', e=>{ tema.fundo=e.target.value; DB.set('tema',tema); aplicarTema(); });
    document.getElementById('logoInput').addEventListener('change', (e)=>{
      const file=e.target.files[0]; if(!file) return; const r=new FileReader(); r.onload=()=>{ tema.logo=r.result; DB.set('tema',tema); aplicarTema(); }; r.readAsDataURL(file);
    });

    // ======= Inicialização =======
    function init(){
      document.getElementById('ano').textContent = new Date().getFullYear();
      aplicarTema();
      renderInsumos(); preencherInsumosSelect();
      renderReceitas(); preencherReceitasSelect();
      renderFluxo(); renderDashboard();
    }
    init();
  </script>
</body>
</html>
